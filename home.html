<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TradeXMatrix.com - Dashboard</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root{
  --bg-color:#121217; --panel-color:#1a1a20; --card-color:#21212c;
  --text-color:#B8B8BD; --highlight:#00A381; --muted:#8b8b90; --border:#2e2e3a;
  --btn-green:#00A381; --btn-green-hover:#007a61;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  color:var(--text-color);
  background:var(--bg-color);
  display:flex;
  min-height:100vh;
  overflow:hidden;
}

/* ---------- SIDEBAR ---------- */
.sidebar{
  width:260px;
  min-width:70px;
  max-width:260px;
  background:var(--panel-color);
  border-right:1px solid var(--border);
  display:flex;
  flex-direction:column;
  transition:width .22s ease, transform .18s ease;
  will-change: width;
}
.sidebar.collapsed{width:70px}

/* header area inside sidebar */
.sidebar .top{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:18px 16px;
  gap:12px;
  border-bottom:1px solid var(--border);
}
.brand {
  display:flex;
  align-items:center;
  gap:12px;
}
.brand img{height:34px; width:auto; display:block;}
.sidebar.collapsed .brand span{display:none}
.brand span{font-weight:700; font-size:1rem; color:white}

/* toggle button (large hit area) */
#sidebar-toggle{
  display:inline-grid;
  place-items:center;
  width:36px;
  height:36px;
  border-radius:8px;
  background:transparent;
  color:var(--highlight);
  border:1px solid transparent;
  cursor:pointer;
}
#sidebar-toggle:hover{background:rgba(0,0,0,0.07);}

/* menu */
.menu{
  flex:1;
  overflow:auto;
  padding:10px 6px;
}
.menu a{
  display:flex;
  align-items:center;
  gap:12px;
  padding:12px 14px;
  margin:6px 6px;
  border-radius:8px;
  color:var(--text-color);
  text-decoration:none;
  transition:background .12s, border-left .12s;
  border-left:3px solid transparent;
}
.menu a i{width:20px; text-align:center; font-size:1.05rem}
.menu a .label{white-space:nowrap; font-weight:600}
.menu a:hover{background:rgba(255,255,255,0.02); border-left:3px solid var(--highlight)}

/* footer area inside sidebar (social + feedback) */
.sidebar .bottom{
  padding:12px 10px;
  border-top:1px solid var(--border);
  display:flex;
  flex-direction:column;
  gap:10px;
  align-items:center;
}
.socials{
  display:flex;
  gap:10px;
  align-items:center;
}
.socials a{
  display:flex;
  gap:8px;
  align-items:center;
  padding:8px;
  border-radius:8px;
  color:var(--highlight);
  text-decoration:none;
  transition:all .12s;
}
.socials a:hover{background:rgba(255,255,255,0.02); color:white}
.socials a .text{font-size:.85rem; color:var(--muted)}
.sidebar.collapsed .socials a .text{display:none}

/* ---------- MAIN ---------- */
.main{
  flex:1;
  display:flex;
  flex-direction:column;
  overflow:auto;
  padding:28px;
}

/* header top bar */
.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:16px;
  margin-bottom:22px;
}
.h-title{font-size:1.25rem; font-weight:700; color:white}
.user-row{display:flex; align-items:center; gap:14px}
.avatar{
  width:52px; height:52px; border-radius:50%; overflow:hidden; border:2px solid var(--highlight);
  display:inline-block; background:#222; flex-shrink:0;
}
.avatar img{width:100%; height:100%; object-fit:cover; display:block}
.username{font-weight:700}
.signout{
  padding:10px 16px; background:var(--btn-green); border:none; color:white; border-radius:8px; cursor:pointer;
  font-weight:700; box-shadow:0 6px 18px rgba(0,163,129,0.14);
}
.signout:hover{background:var(--btn-green-hover)}

/* content grid */
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
  gap:20px;
}

/* cards */
.card{
  background:var(--card-color);
  border-radius:12px;
  padding:18px;
  border:1px solid var(--border);
  transition:transform .14s, box-shadow .14s;
}
.card:hover{transform:translateY(-6px); box-shadow:0 14px 36px rgba(0,0,0,0.5)}

/* performance area */
.performance {
  display:flex; flex-direction:column; align-items:center; gap:14px;
}

/* event list */
.events-list{list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:8px}
.events-list li{padding:8px 10px; border-radius:8px; background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.02)}

/* small screens */
@media (max-width:880px){
  .sidebar{position:fixed; z-index:50; height:100vh; transform:translateX(0)}
  .sidebar.collapsed{width:70px}
  .main{padding:16px}
}
</style>
</head>
<body>

<!-- SIDEBAR -->
<aside class="sidebar" id="sidebar" aria-expanded="true">
  <div class="top">
    <div class="brand">
      <img src="https://raw.githubusercontent.com/TM1476/TradeXMatrix/main/logo-pica.png" alt="TXM logo" />
      <span>TradeXMatrix</span>
    </div>
    <button id="sidebar-toggle" aria-label="Toggle menu" title="Toggle menu">
      <i class="fa-solid fa-bars"></i>
    </button>
  </div>

  <nav class="menu" id="menu">
    <a href="#" data-key="dashboard"><i class="fa-solid fa-gauge-high"></i><span class="label">Dashboard</span></a>
    <a href="#" data-key="charts"><i class="fa-solid fa-chart-line"></i><span class="label">Live Charts</span></a>
    <a href="#" data-key="indicators"><i class="fa-solid fa-layer-group"></i><span class="label">Indicators</span></a>
    <a href="#" data-key="updates"><i class="fa-solid fa-arrow-trend-up"></i><span class="label">Stock Updates</span></a>
    <a href="#" data-key="news"><i class="fa-solid fa-globe"></i><span class="label">News & Events</span></a>
    <a href="#" data-key="education"><i class="fa-solid fa-graduation-cap"></i><span class="label">Education</span></a>
    <a href="#" data-key="pricing"><i class="fa-solid fa-tags"></i><span class="label">Pricing</span></a>
    <a href="#" data-key="settings"><i class="fa-solid fa-user-gear"></i><span class="label">Settings</span></a>
    <a href="#" data-key="feedback"><i class="fa-solid fa-comment-dots"></i><span class="label">Feedback</span></a>
  </nav>

  <div class="bottom sidebar-footer" id="sidebar-footer">
    <div class="socials">
      <a href="https://x.com/Trade_X_Matrix?t=ErdQ5uh34oKHrueT47HNqQ&s=08" target="_blank" rel="noopener">
        <i class="fab fa-twitter"></i><span class="text">Twitter</span>
      </a>
      <a href="https://www.instagram.com/trade_x_matrix" target="_blank" rel="noopener">
        <i class="fab fa-instagram"></i><span class="text">Instagram</span>
      </a>
      <a href="mailto:support@tradexmatrix.com">
        <i class="fa-solid fa-envelope"></i><span class="text">Support</span>
      </a>
    </div>
  </div>
</aside>

<!-- MAIN -->
<main class="main" id="main">
  <header class="header">
    <div class="h-title">TradeXMatrix.com - Dashboard</div>
    <div class="user-row">
      <div class="avatar" id="avatar"><img alt="avatar" src="https://i.imgur.com/your-default-avatar.png" /></div>
      <div class="username" id="username">Loading...</div>
      <button class="signout" id="signoutBtn">Sign Out</button>
    </div>
  </header>

  <section class="grid">
    <article class="card performance-card">
      <h3>Performance</h3>
      <div class="performance">
        <canvas id="performanceChart" width="200" height="200" aria-hidden="false"></canvas>
        <div id="performanceText" style="font-weight:700;font-size:1.1rem;color:white">0%</div>
      </div>
    </article>

    <article class="card events-card">
      <h3>Daily Events</h3>
      <ul class="events-list" id="eventsList">
        <li>No events yet.</li>
      </ul>
    </article>

    <article class="card charts-card">
      <h3>Live Charts & Indicators</h3>
      <p style="color:var(--muted)">Trading widgets will be embedded here (TradingView / custom charts).</p>
    </article>
  </section>
</main>

<script type="module">
/*
  Key improvements in this script:
  - Robust repeated toggle (add/remove .collapsed reliably and update aria-expanded)
  - Username fetch from Firebase Firestore (users collection, field: username)
  - Chart.js loaded before drawing the chart (draw happens only once Chart.js is available)
  - Performance defaults to 0% until you set it (you can update later from Firestore)
*/

import { auth, db } from './src/firebase/firebase.js';
import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { doc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

/* ---------- toggle logic ---------- */
const sidebar = document.getElementById('sidebar');
const toggleBtn = document.getElementById('sidebar-toggle');
toggleBtn.addEventListener('click', () => {
  // Toggle collapsed class and update aria-expanded for accessibility
  const isCollapsed = sidebar.classList.toggle('collapsed');
  sidebar.setAttribute('aria-expanded', String(!isCollapsed));
  // store state so repeated clicks and navigation preserve user's preference
  try { localStorage.setItem('txm_sidebar_collapsed', isCollapsed ? '1' : '0'); } catch(e){}
});

// restore preference on load (if available)
try {
  const saved = localStorage.getItem('txm_sidebar_collapsed');
  if (saved === '1') sidebar.classList.add('collapsed');
  else sidebar.classList.remove('collapsed');
  sidebar.setAttribute('aria-expanded', String(!sidebar.classList.contains('collapsed')));
} catch(e){}

/* ---------- Sign out ---------- */
const signoutBtn = document.getElementById('signoutBtn');
signoutBtn.addEventListener('click', async () => {
  try {
    await signOut(auth);
  } catch(e){
    console.error('Sign out failed', e);
  } finally {
    window.location.href = 'login.html';
  }
});

/* ---------- Chart.js loader + draw ---------- */
let chartReady = false;
let performanceChartInstance = null;

function loadChartJs() {
  return new Promise((resolve, reject) => {
    if (window.Chart) { chartReady = true; resolve(window.Chart); return; }
    const s = document.createElement('script');
    s.src = "https://cdn.jsdelivr.net/npm/chart.js";
    s.onload = () => { chartReady = true; resolve(window.Chart); };
    s.onerror = reject;
    document.head.appendChild(s);
  });
}

function drawPerformance(percent = 0) {
  const ctx = document.getElementById('performanceChart').getContext('2d');
  // destroy previous if exists
  if (performanceChartInstance) performanceChartInstance.destroy();

  performanceChartInstance = new Chart(ctx, {
    type: 'doughnut',
    data: {
      datasets: [{
        data: [percent, 100 - percent],
        backgroundColor: [getComputedStyle(document.documentElement).getPropertyValue('--highlight').trim() || '#00A381', '#2e2e3a'],
        borderWidth: 0,
      }]
    },
    options: {
      cutout: '75%',
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } }
    }
  });

  document.getElementById('performanceText').innerText = `${percent}%`;
}

/* ---------- Firebase: fetch username & optionally performance/events ---------- */
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = 'login.html';
    return;
  }

  // load Chart.js first so we can draw when we have data
  try { await loadChartJs(); } catch(e) { console.warn('Chart.js failed to load', e); }

  // fetch user doc
  try {
    const userRef = doc(db, 'users', user.uid);
    const userSnap = await getDoc(userRef);
    if (userSnap.exists()) {
      const u = userSnap.data();
      // username
      const usernameEl = document.getElementById('username');
      usernameEl.textContent = u.username && u.username.trim() ? u.username : (user.displayName || user.email || 'Trader');

      // avatar: we do NOT fetch/override avatar from Firestore per your last instructions
      // performance value (optional)
      const percent = (typeof u.performance === 'number') ? Math.max(0, Math.min(100, u.performance)) : 0;
      drawPerformance(percent);

      // daily events if you store them per-user inside the user doc (array)
      const eventsList = document.getElementById('eventsList');
      eventsList.innerHTML = '';
      if (Array.isArray(u.dailyEvents) && u.dailyEvents.length) {
        u.dailyEvents.slice(0, 10).forEach(ev => {
          const li = document.createElement('li'); li.textContent = ev; eventsList.appendChild(li);
        });
      } else {
        // If you keep global events somewhere else, update this code to fetch them.
        const li = document.createElement('li'); li.textContent = 'No events yet.'; eventsList.appendChild(li);
      }
    } else {
      // No user doc found — show fallback username
      document.getElementById('username').textContent = user.displayName || user.email || 'Trader';
      drawPerformance(0);
    }
  } catch (err) {
    console.error('Failed to load user data', err);
    document.getElementById('username').textContent = user.displayName || user.email || 'Trader';
    drawPerformance(0);
  }
});
</script>
</body>
</html>
