<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TradeXMatrix.com - Dashboard</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root{
  --bg:#121217; --panel:#1a1a20; --card:#21212c; --muted:#8b8b90;
  --text:#B8B8BD; --accent:#00A381; --border:#2e2e3a; --green:#00A381; --green-hover:#007a61;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto; background:var(--bg); color:var(--text);
  display:flex; min-height:100vh; overflow:hidden;
}

/* SIDEBAR */
.sidebar{
  width:260px; min-width:70px; background:var(--panel); border-right:1px solid var(--border);
  display:flex; flex-direction:column; transition:width .22s ease; will-change:width;
}
.sidebar.collapsed{width:70px}
.sidebar .top{display:flex; align-items:center; justify-content:space-between; padding:16px 14px; border-bottom:1px solid var(--border)}
.brand{display:flex; gap:12px; align-items:center}
.brand img{height:36px; width:auto;}
.brand .title{font-weight:700; font-size:1rem}
.sidebar.collapsed .brand .title{display:none}

/* toggle */
#sidebar-toggle{width:36px;height:36px;border-radius:8px;background:transparent;border:1px solid transparent;color:var(--accent);cursor:pointer;display:grid;place-items:center}
#sidebar-toggle:hover{background:rgba(255,255,255,0.03)}

/* menu */
.menu{flex:1; overflow:auto;padding:10px}
.menu a{display:flex; gap:12px; align-items:center; padding:10px 14px; border-radius:8px; color:var(--text); text-decoration:none; margin:6px 6px; transition:background .12s, border-left .12s; border-left:3px solid transparent}
.menu a i{width:20px;text-align:center}
.menu a .label{font-weight:600; white-space:nowrap}
.menu a:hover{background:rgba(255,255,255,0.02); border-left:3px solid var(--accent)}
.sidebar.collapsed .menu a .label{display:none}

/* footer (social + feedback) */
.bottom{padding:12px 14px;border-top:1px solid var(--border);display:flex;flex-direction:column;gap:10px;align-items:center}
.socials{display:flex;gap:10px}
.socials a{display:flex;gap:8px;align-items:center;padding:8px;border-radius:8px;color:var(--accent);text-decoration:none}
.socials a:hover{background:rgba(255,255,255,0.02); color:white}
.socials a .text{font-size:.85rem;color:var(--muted)}
.sidebar.collapsed .socials a .text{display:none}

/* MAIN */
.main{flex:1; display:flex; flex-direction:column; overflow:auto; padding:24px}
.header{display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:20px}
.h-title{font-size:1.15rem; font-weight:700; color:white}
.user-row{display:flex; align-items:center; gap:12px}
.avatar{width:52px;height:52px;border-radius:50%;overflow:hidden;border:2px solid var(--accent); background:#222}
.avatar img{width:100%;height:100%;object-fit:cover;display:block}
.username{font-weight:700}
.signout{padding:10px 14px;background:var(--green);border:none;color:white;border-radius:8px;font-weight:700;cursor:pointer;box-shadow:0 8px 20px rgba(0,163,129,0.12)}
.signout:hover{background:var(--green-hover)}

/* GRID of cards */
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:18px}

/* cards */
.card{background:var(--card); border-radius:12px; padding:16px; border:1px solid var(--border); transition:transform .12s}
.card:hover{transform:translateY(-6px); box-shadow:0 18px 40px rgba(0,0,0,0.5)}

/* performance card specifics */
.performance-wrap{display:flex;flex-direction:column;align-items:center;gap:12px;height:100%}
.canvas-holder{width:190px;height:190px;}

/* events list */
.events-list{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:8px}
.events-list li{padding:10px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02);font-size:0.95rem;color:var(--text)}

/* responsive */
@media (max-width:900px){
  .sidebar{position:fixed;z-index:40;left:0;top:0;bottom:0;transform:translateX(0)}
  .main{padding:16px}
}
</style>
</head>
<body>

<!-- SIDEBAR -->
<aside id="sidebar" class="sidebar" aria-expanded="true">
  <div class="top">
    <div class="brand"><img src="https://raw.githubusercontent.com/TM1476/TradeXMatrix/main/logo-pica.png" alt="logo"><span class="title">TradeXMatrix</span></div>
    <button id="sidebar-toggle" aria-label="Toggle menu" title="Toggle menu"><i class="fa-solid fa-bars"></i></button>
  </div>

  <nav class="menu" id="menu">
    <a href="#" data-key="dashboard"><i class="fa-solid fa-gauge-high"></i><span class="label">Dashboard</span></a>
    <a href="#" data-key="charts"><i class="fa-solid fa-chart-line"></i><span class="label">Live Charts</span></a>
    <a href="#" data-key="indicators"><i class="fa-solid fa-layer-group"></i><span class="label">Indicators</span></a>
    <a href="#" data-key="updates"><i class="fa-solid fa-arrow-trend-up"></i><span class="label">Stock Updates</span></a>
    <a href="#" data-key="news"><i class="fa-solid fa-globe"></i><span class="label">News & Events</span></a>
    <a href="#" data-key="education"><i class="fa-solid fa-graduation-cap"></i><span class="label">Education</span></a>
    <a href="#" data-key="pricing"><i class="fa-solid fa-tags"></i><span class="label">Pricing</span></a>
    <a href="#" data-key="settings"><i class="fa-solid fa-user-gear"></i><span class="label">Settings</span></a>
    <a href="#" data-key="feedback"><i class="fa-solid fa-comment-dots"></i><span class="label">Feedback</span></a>
  </nav>

  <div class="bottom">
    <div class="socials">
      <a href="https://x.com/Trade_X_Matrix?t=ErdQ5uh34oKHrueT47HNqQ&s=08" target="_blank" rel="noopener"><i class="fab fa-x-twitter"></i><span class="text">Twitter</span></a>
      <a href="https://www.instagram.com/trade_x_matrix" target="_blank" rel="noopener"><i class="fab fa-instagram"></i><span class="text">Instagram</span></a>
      <a href="mailto:support@tradexmatrix.com"><i class="fa-solid fa-envelope"></i><span class="text">Support</span></a>
    </div>
  </div>
</aside>

<!-- MAIN -->
<main class="main" id="main">
  <header class="header">
    <div class="h-title">TradeXMatrix.com - Dashboard</div>
    <div class="user-row">
      <div class="avatar" id="avatar"><img src="https://raw.githubusercontent.com/TM1476/TradeXMatrix/main/avatar.png" alt="avatar"></div>
      <div class="username" id="username">Loading...</div>
      <button id="signoutBtn" class="signout">Sign Out</button>
    </div>
  </header>

  <section class="grid">
    <article class="card performance-card">
      <h3>Performance</h3>
      <div class="performance-wrap">
        <div class="canvas-holder"><canvas id="performanceChart" aria-hidden="false"></canvas></div>
        <div id="performanceText" style="font-weight:700;font-size:1.05rem;color:white">0%</div>
      </div>
    </article>

    <article class="card events-card">
      <h3>News & Daily Events</h3>
      <ul class="events-list" id="eventsList">
        <li>Loading events...</li>
      </ul>
    </article>

    <article class="card charts-card">
      <h3>Live Charts & Indicators</h3>
      <p style="color:var(--muted)">Embed TradingView or your custom chart widgets here. Responsive container is ready.</p>
      <div id="tradingview-container" style="height:320px; margin-top:12px; border-radius:8px; overflow:hidden; background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));"></div>
    </article>
  </section>
</main>

<script type="module">
/* Dashboard script:
 - Robust repeated toggle saved to localStorage
 - Fetch username from Firestore (users/<uid>.username)
 - Real-time events feed from collection 'events' using onSnapshot (ordered by timestamp desc)
 - Chart.js loaded dynamically and chart drawn with user performance (0 default)
 - Responsive layout; performance updates real-time if you update the user doc
*/

import { auth, db } from './src/firebase/firebase.js';
import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { doc, getDoc, collection, query, orderBy, limit, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

/* Sidebar toggle (reliable) */
const sidebar = document.getElementById('sidebar');
const toggle = document.getElementById('sidebar-toggle');
toggle.addEventListener('click', () => {
  const collapsed = sidebar.classList.toggle('collapsed');
  sidebar.setAttribute('aria-expanded', String(!collapsed));
  try { localStorage.setItem('txm_sidebar_collapsed','' + (collapsed ? '1' : '0')); } catch(e){}
});
// restore
try {
  const saved = localStorage.getItem('txm_sidebar_collapsed');
  if (saved === '1') sidebar.classList.add('collapsed');
  else sidebar.classList.remove('collapsed');
  sidebar.setAttribute('aria-expanded', String(!sidebar.classList.contains('collapsed')));
} catch(e){}

/* Sign out */
document.getElementById('signoutBtn').addEventListener('click', async ()=> {
  try { await signOut(auth); } catch(e){ console.error(e); }
  window.location.href = 'login.html';
});

/* Load Chart.js dynamically once */
function loadChartJs(){
  return new Promise((resolve,reject)=>{
    if(window.Chart) resolve(window.Chart);
    const s = document.createElement('script');
    s.src = "https://cdn.jsdelivr.net/npm/chart.js";
    s.onload = ()=> resolve(window.Chart);
    s.onerror = reject;
    document.head.appendChild(s);
  });
}

/* Draw performance doughnut and return instance */
let perfChart = null;
async function drawPerformance(percent = 0){
  const ChartLib = await loadChartJs();
  const canvas = document.getElementById('performanceChart');
  if(perfChart){ try { perfChart.destroy(); } catch(e){} }
  perfChart = new ChartLib(canvas.getContext('2d'), {
    type:'doughnut',
    data: { datasets: [{ data:[percent, 100-percent], backgroundColor:[getComputedStyle(document.documentElement).getPropertyValue('--accent') || '#00A381','#2e2e3a'], borderWidth:0 }] },
    options: { cutout: '75%', responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }
  });
  document.getElementById('performanceText').innerText = `${percent}%`;
}

/* Real-time events (collection: 'events') */
function listenEvents(){
  try {
    const eventsListEl = document.getElementById('eventsList');
    const eventsCol = collection(db,'events');
    const q = query(eventsCol, orderBy('timestamp','desc'), limit(20));
    // unsubscribe old if any by returning closure? For simplicity, use onSnapshot directly
    onSnapshot(q, (snapshot)=>{
      eventsListEl.innerHTML = '';
      if(snapshot.empty){ eventsListEl.innerHTML = '<li>No events yet.</li>'; return; }
      snapshot.forEach(docSnap=>{
        const ev = docSnap.data();
        const li = document.createElement('li');
        // nice format: title (time)
        const time = ev.timestamp && ev.timestamp.toDate ? ev.timestamp.toDate() : (ev.timestamp ? new Date(ev.timestamp) : null);
        li.textContent = ev.title + (time ? ' â€” ' + time.toLocaleString() : '');
        eventsListEl.appendChild(li);
      });
    }, (err)=> {
      console.error('events onSnapshot error', err);
      document.getElementById('eventsList').innerHTML = '<li>Unable to load events.</li>';
    });
  } catch(e){
    console.error('listenEvents failed', e);
  }
}

/* Auth: get username and performance; draw chart with performance */
onAuthStateChanged(auth, async (user)=>{
  if(!user){ window.location.href = 'login.html'; return; }

  // Start listening for site-wide events
  listenEvents();

  // Load Chart.js as soon as possible
  await loadChartJs().catch(err=>console.warn('Chart.js failed to load',err));

  // Fetch user document
  try {
    const userRef = doc(db,'users', user.uid);
    const snap = await getDoc(userRef);
    if(snap.exists()){
      const data = snap.data();
      const name = (data && data.username && data.username.trim()) ? data.username : (user.displayName || user.email || 'Trader');
      document.getElementById('username').innerText = name;

      // use performance if provided (0-100)
      const perf = (typeof data.performance === 'number') ? Math.max(0, Math.min(100, data.performance)) : 0;
      await drawPerformance(perf);

      // If you want to listen to changes in the user's document in real-time, you can replace getDoc with onSnapshot.
      // Example: onSnapshot(doc(db,'users',user.uid), doc => { ... update chart/update username ... })
    } else {
      // fallback: use firebase auth displayName/email
      document.getElementById('username').innerText = user.displayName || user.email || 'Trader';
      await drawPerformance(0);
    }
  } catch(err){
    console.error('Failed to load user data', err);
    document.getElementById('username').innerText = user.displayName || user.email || 'Trader';
    await drawPerformance(0);
  }
});
</script>
</body>
</html>
