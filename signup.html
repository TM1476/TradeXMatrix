<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade X Matrix - Sign Up</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
    
    <style>
        /* Base Styles */
        :root {
            --bg-color: #121217;
            --panel-color: #1a1a20;
            --text-color: #B8B8BD;
            --highlight-color: #00A381;
            --border-color: #2e2e3a;
            --card-color: #21212c;
            --btn-bg-hover: #007a61;
            --modal-bg-color: #1a1a20;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            min-height: 100vh;
            overflow-x: hidden;
            font-family: 'Inter', sans-serif;
            color: var(--text-color);
            background-color: var(--bg-color);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        /* New Animated Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(13, 13, 18, 0.95), rgba(18, 18, 23, 0.9));
            z-index: -1;
        }

        .animated-dots {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: -2;
        }

        .dot {
            position: absolute;
            background-color: rgba(0, 163, 129, 0.2);
            border-radius: 50%;
            animation: moveDot 20s infinite ease-in-out;
        }

        .dot.large { width: 5px; height: 5px; opacity: 0.2; }
        .dot.medium { width: 3px; height: 3px; opacity: 0.3; }
        .dot.small { width: 2px; height: 2px; opacity: 0.4; }

        @keyframes moveDot {
            0% { transform: translate(var(--x-start), var(--y-start)); }
            100% { transform: translate(var(--x-end), var(--y-end)); }
        }

        /* Signup Page Layout */
        .signup-page {
            display: flex;
            width: 100%;
            max-width: 900px;
            background-color: var(--card-color);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            overflow: hidden;
            min-height: 550px;
            z-index: 10;
        }

        .signup-details {
            flex: 1;
            padding: 40px;
            background-color: var(--panel-color);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        
        .signup-details h2 {
            font-size: 2.5rem;
            color: white;
            margin-bottom: 20px;
        }
        
        .signup-details p {
            max-width: 350px;
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 20px;
        }
        
        .signup-details ul {
            list-style: none;
            text-align: left;
            margin-bottom: 30px;
        }
        
        .signup-details ul li {
            margin-bottom: 15px;
            color: white;
            font-weight: 500;
            font-size: 0.95rem;
        }
        
        .signup-details ul li i {
            color: var(--highlight-color);
            margin-right: 10px;
        }

        .signup-form-container {
            flex: 1;
            padding: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .logo {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
        }
        
        .logo img {
            height: 200px;
            width: 370px;
        }

        h3 {
            font-size: 1.8rem;
            color: white;
            margin-bottom: 10px;
            text-align: center;
        }
        
        p.form-description {
            font-size: 0.9rem;
            color: var(--text-color);
            margin-bottom: 30px;
            text-align: center;
        }

        .signup-form .input-group {
            margin-bottom: 20px;
            position: relative;
        }
        
        .signup-form label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: white;
            font-weight: 500;
        }
        
        .signup-form input {
            width: 100%;
            padding: 12px;
            background-color: var(--panel-color);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: white;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        
        .signup-form input:focus {
            outline: none;
            border-color: var(--highlight-color);
        }

        /* Dynamic Validation States */
        .validation-message {
            font-size: 0.8rem;
            color: #ff6347;
            margin-top: 5px;
            display: none;
        }
        
        .validation-message.show {
            display: block;
        }

        /* Password Toggle Styles */
        .password-input-wrapper {
            position: relative;
        }
        
        .password-toggle-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-color);
            cursor: pointer;
            transition: color 0.2s ease;
        }
        
        .password-toggle-icon:hover {
            color: white;
        }

        .signup-form button {
            width: 100%;
            padding: 15px;
            background-color: var(--highlight-color);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        .signup-form button:hover {
            background-color: var(--btn-bg-hover);
        }

        /* Terms and Policy Checkbox */
        .terms-policy-group {
            display: flex;
            align-items: flex-start;
            margin-bottom: 25px;
            font-size: 0.9rem;
            padding-right: 10px;
        }

        .terms-policy-group input[type="checkbox"] {
            margin-top: 2px;
            margin-right: 10px;
            width: 16px;
            height: 16px;
            border: 1px solid var(--border-color);
            background-color: var(--panel-color);
            accent-color: var(--highlight-color);
        }

        .terms-policy-group a {
            color: var(--highlight-color);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s;
        }

        .terms-policy-group a:hover {
            color: white;
            text-decoration: underline;
        }

        #terms-policy-validation {
            margin-top: -15px;
            margin-bottom: 20px;
        }

        /* Social Login Styles (MODIFIED) */
        .social-login {
            text-align: center;
            margin-top: 0;
            margin-bottom: 30px; 
        }

        .social-login .or-separator {
            display: flex;
            align-items: center;
            text-align: center;
            margin: 20px 0;
            color: var(--text-color);
            font-size: 0.9rem;
        }
        
        .social-login .or-separator::before,
        .social-login .or-separator::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid var(--border-color);
            margin: 0 10px;
        }
        
        .social-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        
        .social-button i {
            margin-right: 10px;
            font-size: 1.2rem;
        }

        /* Google Specific Style */
        .social-button.google-btn {
            background-color: #4285F4;
            color: white;
            border-color: #4285F4;
        }

        .social-button.google-btn:hover {
            background-color: #357ae8;
            border-color: #357ae8;
        }


        /* --- Modal Styles for TOS and PP --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--modal-bg-color);
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            transform: scale(0.95);
            transition: transform 0.3s ease-out;
        }

        .modal-overlay.active .modal-content {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
        }

        .modal-header h4 {
            color: white;
            font-size: 1.5rem;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.2s;
        }

        .modal-close:hover {
            color: var(--highlight-color);
        }

        .modal-body {
            overflow-y: auto;
            color: var(--text-color);
            line-height: 1.6;
            flex-grow: 1;
        }

        .modal-body h5 {
            color: white;
            font-size: 1.1rem;
            margin-top: 15px;
            margin-bottom: 5px;
        }

        .modal-body p, .modal-body ul {
            margin-bottom: 15px;
            font-size: 0.95rem;
        }

        .modal-body ul {
            padding-left: 25px;
            list-style: disc;
        }

        .modal-body ul li {
            margin-bottom: 5px;
            font-size: 0.95rem;
            line-height: 1.4;
        }
        
        /* Scrollbar styling for a darker, professional look */
        .modal-body::-webkit-scrollbar {
            width: 8px;
        }

        .modal-body::-webkit-scrollbar-track {
            background: var(--card-color);
            border-radius: 4px;
        }

        .modal-body::-webkit-scrollbar-thumb {
            background-color: var(--border-color);
            border-radius: 4px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .signup-page {
                flex-direction: column;
                max-width: 450px;
            }
            .signup-details {
                display: none;
            }
            .signup-form-container {
                padding: 30px;
            }
            .modal-content {
                max-width: 95%;
                padding: 20px;
            }
            .modal-body {
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div class="animated-dots"></div>
    <div class="signup-page">
        <div class="signup-details">
            <div class="logo">
                <img src="https://raw.githubusercontent.com/TM1476/TradeXMatrix/main/logo-pica.png" alt="TXM Logo" />
            </div>
            <h2>Join the Platform</h2>
            <p>
                Create your free account to get immediate access to our full suite of professional trading tools, exclusive market insights, and real-time data.
            </p>
            <ul>
                <li><i class="fa-solid fa-chart-line"></i> Advanced Live Charting</li>
                <li><i class="fa-solid fa-bell"></i> Personalized Trading Alerts</li>
                <li><i class="fa-solid fa-headset"></i> Dedicated Customer Support</li>
                <li><i class="fa-solid fa-users"></i> Exclusive Community Access</li>
            </ul>
        </div>

        <div class="signup-form-container">
            <h3>Create a Free Account</h3>
            
            <div class="social-login">
                <a href="#" class="social-button google-btn" id="google-signup">
                    <i class="fab fa-google"></i> Sign up with Google
                </a>
                
                <div class="or-separator">or</div>
            </div>

            <form class="signup-form" onsubmit="event.preventDefault(); validateForm();">
                <div class="input-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" name="username" required minlength="3">
                    <span id="username-validation" class="validation-message"></span>
                </div>
                <div class="input-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" required>
                    <span id="email-validation" class="validation-message"></span>
                </div>
                <div class="input-group">
                    <label for="password">Password</label>
                    <div class="password-input-wrapper">
                        <input type="password" id="password" name="password" required>
                        <i class="fas fa-eye password-toggle-icon" id="toggle-password"></i>
                    </div>
                    <span id="password-validation" class="validation-message"></span>
                </div>
                <div class="input-group">
                    <label for="confirm-password">Confirm Password</label>
                    <div class="password-input-wrapper">
                        <input type="password" id="confirm-password" name="confirm-password" required>
                        <i class="fas fa-eye password-toggle-icon" id="toggle-confirm-password"></i>
                    </div>
                    <span id="confirm-password-validation" class="validation-message"></span>
                </div>

                <div class="g-recaptcha" data-sitekey="6Lecd9ArAAAAAG0TRqJrmeFpjT7_og0I1eYZ7fBX"></div>
                
                <div class="terms-policy-group">
                    <input type="checkbox" id="agree-terms" name="agree-terms" required>
                    <label for="agree-terms">I agree to the <a href="#" onclick="showModal('tos-modal'); return false;">Terms of Service</a> and <a href="#" onclick="showModal('pp-modal'); return false;">Privacy Policy</a>.</label>
                </div>
                <span id="terms-policy-validation" class="validation-message">You must agree to the Terms of Service and Privacy Policy.</span>
                <span id="recaptcha-validation" class="validation-message">Please complete the CAPTCHA.</span>
                
                <button type="submit">Create Account</button>
            </form>
        </div>
    </div>
    
    <div id="tos-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h4>Terms of Service (TOS)</h4>
                <button type="button" class="modal-close" onclick="closeModal('tos-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <h5>1. Acceptance of Terms</h5>
                <p>By accessing or using this app, you agree to these Terms of Service and acknowledge that all content is provided for educational and informational purposes only.</p>
                
                <h5>2. Educational Purpose Only</h5>
                <p>All materials, including tutorials, indicators, charts, news, forecasts, and the Indian stock list, are for educational purposes. Nothing in this app constitutes financial, investment, or trading advice.</p>
                
                <h5>3. No Guarantee</h5>
                <p>Use of indicators, charts, educational content, and stock lists does not guarantee profits. Users are responsible for any trading decisions made outside of this app.</p>
                
                <h5>4. Stock List Feature</h5>
                <p>The Indian stock list provides historical performance and sector information for educational reference only. Past performance is not indicative of future results. This app does not recommend buying or selling any stock.</p>
                
                <h5>5. Account</h5>
                <p>Users may create accounts for progress tracking, saving preferences, or demo learning. No real-money trading is offered.</p>
                
                <h5>6. Restrictions</h5>
                <p>Users may not:</p>
                <ul>
                    <li>Use the app to execute real-money trades</li>
                    <li>Claim guarantees based on app content</li>
                    <li>Copy or redistribute app content without permission</li>
                </ul>
                
                <h5>7. Data Usage</h5>
                <p>The app may collect anonymized usage data to improve functionality. Personal information is protected under our Privacy Policy.</p>
                
                <h5>8. Liability</h5>
                <p>The app and its developers are not liable for any losses resulting from use of the app or its content. All users act at their own risk.</p>
                
                <h5>9. Changes to Terms</h5>
                <p>We may update these Terms at any time. Continued use of the app constitutes acceptance of the revised Terms.</p>
                
                <h5>10. Contact</h5>
                <p>For questions about these Terms, contact us at <a href="mailto:support@tradexmatrix.com">support@tradexmatrix.com</a>.</p>
            </div>
        </div>
    </div>

    <div id="pp-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h4>Privacy Policy</h4>
                <button type="button" class="modal-close" onclick="closeModal('pp-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <h5>1. Information We Collect</h5>
                <ul>
                    <li>Account information (email, username)</li>
                    <li>Usage data (app interactions, courses accessed)</li>
                    <li>Analytics data (device type, app version)</li>
                    <li>Optional preferences for personalized content</li>
                </ul>
                
                <h5>2. How We Use Information</h5>
                <ul>
                    <li>To provide and improve app functionality</li>
                    <li>To personalize educational content</li>
                    <li>To analyze trends and user engagement</li>
                </ul>
                
                <h5>3. Data Sharing</h5>
                <ul>
                    <li>We do not sell personal information</li>
                    <li>Aggregated, anonymized data may be shared for research or analytics</li>
                </ul>
                
                <h5>4. Security</h5>
                <p>Reasonable security measures are in place to protect user data. No sensitive financial information is collected as no real-money trading is offered.</p>
                
                <h5>5. Cookies & Tracking</h5>
                <p>The app may use cookies or analytics tools to improve user experience.</p>
                
                <h5>6. User Rights</h5>
                <ul>
                    <li>Users can request deletion of personal data</li>
                    <li>Users can opt out of non-essential tracking</li>
                </ul>
                
                <h5>7. Changes to Privacy Policy</h5>
                <p>We may update this Policy. Continued use of the app indicates acceptance.</p>
                
                <h5>8. Contact</h5>
                <p>For privacy questions, contact us at <a href="mailto:support@tradexmatrix.com">support@tradexmatrix.com</a>.</p>
            </div>
        </div>
    </div>

    <script>
        // --- Animated Background Script ---
        const animatedDots = document.querySelector('.animated-dots');
        const numberOfDots = 50;

        for (let i = 0; i < numberOfDots; i++) {
            const dot = document.createElement('div');
            dot.classList.add('dot');
            dot.style.setProperty('--x-start', Math.random() * 100 + 'vw');
            dot.style.setProperty('--y-start', Math.random() * 100 + 'vh');
            dot.style.setProperty('--x-end', Math.random() * 100 + 'vw');
            dot.style.setProperty('--y-end', Math.random() * 100 + 'vh');
            dot.style.animationDuration = (Math.random() * 15 + 10) + 's';
            dot.style.animationDelay = (Math.random() * 5) + 's';
            dot.style.width = dot.style.height = (Math.random() * 3 + 1) + 'px';
            animatedDots.appendChild(dot);
        }


        // --- Form Validation Scripts ---
        const usernameInput = document.getElementById('username');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const confirmPasswordInput = document.getElementById('confirm-password');
        const termsCheckbox = document.getElementById('agree-terms');
        
        const usernameValidation = document.getElementById('username-validation');
        const emailValidation = document.getElementById('email-validation');
        const passwordValidation = document.getElementById('password-validation');
        const confirmPasswordValidation = document.getElementById('confirm-password-validation');
        const recaptchaValidation = document.getElementById('recaptcha-validation');
        const termsPolicyValidation = document.getElementById('terms-policy-validation');

        function validateUsername() {
            if (usernameInput.value.length < 3) {
                usernameValidation.textContent = 'Username must be at least 4 characters long.';
                usernameValidation.classList.add('show');
                return false;
            } else {
                usernameValidation.classList.remove('show');
                return true;
            }
        }
        
        function validateEmail() {
            const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
            if (!emailRegex.test(emailInput.value)) {
                emailValidation.textContent = 'Please enter a valid email address.';
                emailValidation.classList.add('show');
                return false;
            } else {
                emailValidation.classList.remove('show');
                return true;
            }
        }
        
        function validatePassword() {
            const password = passwordInput.value;
            const validations = [];
            let isValid = true;
            
            if (password.length < 8) {
                validations.push("At least 8 characters");
                isValid = false;
            }
            if (!/[A-Z]/.test(password)) {
                validations.push("An uppercase letter");
                isValid = false;
            }
            if (!/[a-z]/.test(password)) {
                validations.push("A lowercase letter");
                isValid = false;
            }
            if (!/[0-9]/.test(password)) {
                validations.push("A number");
                isValid = false;
            }
            if (!/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>/?]/.test(password)) {
                validations.push("A special character");
                isValid = false;
            }
            
            if (!isValid) {
                passwordValidation.textContent = 'Password must contain: ' + validations.join(', ') + '.';
                passwordValidation.classList.add('show');
            } else {
                passwordValidation.classList.remove('show');
            }
            
            return isValid;
        }

        function validateConfirmPassword() {
            if (passwordInput.value !== confirmPasswordInput.value) {
                confirmPasswordValidation.textContent = 'Passwords do not match.';
                confirmPasswordValidation.classList.add('show');
                return false;
            } else {
                confirmPasswordValidation.classList.remove('show');
                return true;
            }
        }

        function validateRecaptcha() {
            if (typeof grecaptcha !== 'undefined') {
                const response = grecaptcha.getResponse();
                if (response.length === 0) {
                    recaptchaValidation.classList.add('show');
                    return false;
                } else {
                    recaptchaValidation.classList.remove('show');
                    return true;
                }
            }
            return true;
        }

        function validateTermsAndPolicy() {
            if (!termsCheckbox.checked) {
                termsPolicyValidation.classList.add('show');
                return false;
            } else {
                termsPolicyValidation.classList.remove('show');
                return true;
            }
        }

        function validateForm() {
            // This is the global validator called by the form submit
            const isUsernameValid = validateUsername();
            const isEmailValid = validateEmail();
            const isPasswordValid = validatePassword();
            const isConfirmPasswordValid = validateConfirmPassword();
            const isTermsAgreed = validateTermsAndPolicy();
            const isRecaptchaValid = validateRecaptcha();

            return isUsernameValid && isEmailValid && isPasswordValid && isConfirmPasswordValid && isTermsAgreed && isRecaptchaValid;
        }

        // --- Password Show/Hide Toggler ---
        document.getElementById('toggle-password').addEventListener('click', function (e) {
            const passwordInput = document.getElementById('password');
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            this.classList.toggle('fa-eye-slash');
        });

        document.getElementById('toggle-confirm-password').addEventListener('click', function (e) {
            const passwordInput = document.getElementById('confirm-password');
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            this.classList.toggle('fa-eye-slash');
        });

        // Add real-time validation on input change
        usernameInput.addEventListener('input', validateUsername);
        emailInput.addEventListener('input', validateEmail);
        passwordInput.addEventListener('input', validatePassword);
        confirmPasswordInput.addEventListener('input', validateConfirmPassword);
        termsCheckbox.addEventListener('change', validateTermsAndPolicy);


        // --- Modal Functions ---
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        // Close modal when clicking outside the content
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    closeModal(overlay.id);
                }
            });
        });

        // Close modal when pressing the ESC key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal-overlay.active').forEach(modal => {
                    closeModal(modal.id);
                });
            }
        });
    </script>
    <script type="module">
        // 1. FIREBASE IMPORTS (v11 Modular SDK via CDN)
        // NOTE: The user's original code had "import { app, auth, db } from './src/firebase/firebase.js';"
        // which assumes a local file. For a self-contained solution, I'm using CDN imports below.
        // If 'firebase.js' is a separate file, the user MUST ensure it's accessible.
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";


        // 2. FIREBASE CONFIGURATION 
        const firebaseConfig = {
            apiKey: "AIzaSyC7OlOJlG6HGombrxytI4mvldAm39YZD-s",
            authDomain: "tradexmatrix-txm.firebaseapp.com",
            projectId: "tradexmatrix-txm",
            storageBucket: "tradexmatrix-txm.firebasestorage.app",
            messagingSenderId: "683396221594",
            appId: "1:683396221594:web:db1669b666607b948d2d23",
            measurementId: "G-RMP0BPSG2X"
        };

        // 3. INITIALIZE SERVICES
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const googleProvider = new GoogleAuthProvider(); // INITIALIZE GOOGLE PROVIDER
        
        const googleSignupButton = document.getElementById('google-signup');
        const signupForm = document.querySelector('.signup-form');
        const termsCheckbox = document.getElementById('agree-terms');


        // 4. FIRESTORE UTILITY FUNCTION - UPDATED
    async function upsertUserProfile(user) {
        const userRef = doc(db, "users", user.uid);
    
        const userData = {
        // --- CORE IDENTITY ---
            uid: user.uid,
            email: user.email,
        // Uses Google's display name if signing up with Google, or the form username
            username: user.displayName || document.getElementById('username').value,
        
        // --- SECURITY & MANAGEMENT ---                              
            accountTier: 'Free',                 // Current status for feature management
            emailVerified: user.emailVerified,           
        
        // --- UX & PERSONALIZATION ---
            onboardingStep: 0,                           
            preferredTimezone: 'Asia/Kolkata',           
            defaultMarket: 'NSE',                        
        
        // --- TRADING FEATURE (Demo Trading) ---
            demoBalance: 100000.00, // Starting virtual balance
        
        // --- TIMESTAMPS ---
            createdAt: serverTimestamp(),
            lastSignIn: serverTimestamp(),
        };
    
    // This merges the new data with any existing data (important for Google sign-in)
    await setDoc(userRef, userData, { merge: true });
}


        // 5. EMAIL/PASSWORD SIGNUP LOGIC
        signupForm.addEventListener('submit', async function(event) {
            // Note: validateForm is called in the HTML inline, but we run it one more time for safety
            if (typeof window.validateForm !== 'function' || !window.validateForm()) {
                 return;
            }

            const username = document.getElementById('username').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await upsertUserProfile(userCredential.user);

                alert("✅ Account created successfully! Redirecting to login..."); 
                window.location.href = "login.html";

            } catch (error) {
                console.error("Signup error:", error.code, error.message);
                let errorMessage = "An unknown error occurred.";
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'This email address is already in use.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'The email address is not valid.';
                }

                alert("❌ Signup failed: " + errorMessage);
            }
        });


        // 6. GOOGLE SIGNUP LOGIC (FUNCTIONAL)
        googleSignupButton.addEventListener('click', async (event) => {
            event.preventDefault();

            // Enforce Terms Agreement
            if (!termsCheckbox.checked) {
                alert("Please agree to the Terms of Service and Privacy Policy before proceeding with Google sign-up.");
                return;
            }
            
            try {
                // *** THIS IS THE CRITICAL LINE THAT OPENS THE GOOGLE SELECTION POPUP ***
                const result = await signInWithPopup(auth, googleProvider);
                const user = result.user;

                // Create/Update Firestore profile 
                await upsertUserProfile(user);
                
                alert("✅ Signed in successfully with Google! Redirecting...");
                window.location.href = "login.html";

            } catch (error) {
                console.error("Google Signup Error:", error.code, error.message);
                let errorMessage = "An unknown error occurred during Google sign-in.";
                
                if (error.code === 'auth/popup-closed-by-user') {
                    errorMessage = 'Sign-in window was closed by the user.';
                } else if (error.code === 'auth/cancelled-popup-request') {
                    errorMessage = 'Please allow popups to continue Google sign-in.';
                } else if (error.code === 'auth/account-exists-with-different-credential') {
                    errorMessage = 'An account with this email already exists using a different sign-in method.';
                }

                alert("❌ Google Sign-in Failed: " + errorMessage);
            }
        });

    </script>
</body>
</html>
