<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TradeXMatrix - Profile</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
  --bg: #0e0e12;
  --card: #1a1a21;
  --text: #c7c7ce;
  --border: #2b2b36;
  --accent: #00a381;
  --accent-hover: #008d70;
  --yellow: #ffcc00;
}

body {
  margin: 0;
  font-family: 'Inter', sans-serif;
  background: var(--bg);
  color: var(--text);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  min-height: 100vh;
  padding: 20px;
}

header {
  width: 100%;
  display: flex;
  justify-content: flex-end;
  align-items: center;
  padding: 15px 30px;
  box-sizing: border-box;
}

.back-btn {
  background: var(--accent);
  color: white;
  padding: 10px 18px;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.3s;
}
.back-btn:hover {
  background: var(--accent-hover);
}

.profile-card {
  width: 100%;
  max-width: 500px;
  background: var(--card);
  padding: 30px;
  border-radius: 14px;
  border: 1px solid var(--border);
  box-shadow: 0 6px 25px rgba(0, 0, 0, 0.4);
  display: flex;
  flex-direction: column;
  gap: 20px;
  text-align: center;
}

.profile-card h2 {
  color: white;
  margin-bottom: 10px;
  font-size: 1.8rem;
}

.avatar {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  border: 2px solid var(--accent);
  overflow: hidden;
  margin: 0 auto;
}
.avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.profile-row {
  text-align: left;
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.profile-row label {
  font-weight: 500;
  color: #aaa;
  font-size: 0.9rem;
}
.profile-row input {
  padding: 10px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: rgba(255,255,255,0.04);
  color: white;
  font-size: 1rem;
}
.profile-row input[readonly] {
  opacity: 0.8;
  cursor: not-allowed;
}

.verify-btn {
  background: var(--yellow);
  color: black;
  border: none;
  padding: 10px 16px;
  border-radius: 8px;
  font-weight: 600;
  margin-top: 8px;
  cursor: pointer;
  transition: background 0.3s;
}
.verify-btn:hover {
  background: #e6b800;
}

.button-row {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 12px;
  margin-top: 15px;
}

.button {
  padding: 10px 16px;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.3s;
  color: white;
}
.save-btn {
  background: var(--accent);
}
.save-btn:hover {
  background: var(--accent-hover);
}
.reset-btn {
  background: #4a4a58;
}
.reset-btn:hover {
  background: #3b3b47;
}

@media (max-width: 600px) {
  .profile-card {
    padding: 20px;
  }
  .profile-card h2 {
    font-size: 1.5rem;
  }
  header {
    padding: 10px 20px;
  }
}
</style>
</head>
<body>

<header>
  <button class="back-btn" onclick="window.location.href='home.html'"><i class="fa-solid fa-arrow-left"></i> Dashboard</button>
</header>

<main class="profile-card">
  <div class="avatar">
    <img src="https://raw.githubusercontent.com/TM1476/TradeXMatrix/main/avatar.png" alt="Avatar">
  </div>
  <h2>Your Profile</h2>

  <div class="profile-row">
    <label>Username</label>
    <input type="text" id="username" placeholder="Enter username">
  </div>

  <div class="profile-row">
    <label>Email</label>
    <input type="text" id="email" readonly>
  </div>

  <div class="profile-row">
    <label>Email Verification Status</label>
    <input type="text" id="emailStatus" readonly>
    <button class="verify-btn" id="verifyEmailBtn" style="display:none;">Verify Email</button>
  </div>

  <div class="profile-row">
    <label>Demo Balance</label>
    <input type="text" id="demoBalance" readonly>
  </div>

  <div class="button-row">
    <button class="button save-btn" id="saveBtn">Save Username</button>
    <button class="button reset-btn" id="resetPasswordBtn">Reset Password</button>
  </div>
</main>

<script type="module">
import { auth, db } from './src/firebase/firebase.js';
import { onAuthStateChanged, sendEmailVerification, sendPasswordResetEmail, updateProfile } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const usernameInput = document.getElementById('username');
const emailInput = document.getElementById('email');
const emailStatusInput = document.getElementById('emailStatus');
const verifyEmailBtn = document.getElementById('verifyEmailBtn');
const demoBalanceInput = document.getElementById('demoBalance');
const saveBtn = document.getElementById('saveBtn');
const resetPasswordBtn = document.getElementById('resetPasswordBtn');

async function updateEmailStatus(user) {
  await user.reload(); // refresh Firebase user state
  if (user.emailVerified) {
    emailStatusInput.value = '✅ Email Verified';
    verifyEmailBtn.style.display = 'none';
  } else {
    emailStatusInput.value = '⚠️ Email Not Verified';
    verifyEmailBtn.style.display = 'inline-block';
  }
}

// Load profile
onAuthStateChanged(auth, async (user) => {
  if (!user) return window.location.href = 'login.html';

  const ref = doc(db, 'users', user.uid);
  const snap = await getDoc(ref);
  if (snap.exists()) {
    const data = snap.data();
    usernameInput.value = data.username || user.displayName || '';
    emailInput.value = user.email;
    demoBalanceInput.value = data.demoBalance || '0';
  }
  await updateEmailStatus(user);
});

// Save username
saveBtn.addEventListener('click', async () => {
  const newUsername = usernameInput.value.trim();
  if (newUsername === '') {
    alert('Username cannot be empty');
    return;
  }
  const user = auth.currentUser;
  await updateProfile(user, { displayName: newUsername });
  const ref = doc(db, 'users', user.uid);
  await updateDoc(ref, { username: newUsername });
  alert('Username updated successfully!');
});

// Reset password
resetPasswordBtn.addEventListener('click', async () => {
  const user = auth.currentUser;
  await sendPasswordResetEmail(auth, user.email);
  alert('Password reset email sent to ' + user.email);
});

// Verify email
verifyEmailBtn.addEventListener('click', async () => {
  const user = auth.currentUser;
  await sendEmailVerification(user);
  alert('Verification email sent to ' + user.email);

  const interval = setInterval(async () => {
    await updateEmailStatus(user);
    if (user.emailVerified) {
      clearInterval(interval);
      alert('Email verified successfully!');
    }
  }, 5000);
});
</script>
</body>
</html>
